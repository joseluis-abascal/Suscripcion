package com.suscripcionAdidas.controller;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.suscripcionAdidas.dao.SuscripcionDAO;
import com.suscripcionAdidas.model.Respuesta;
import com.suscripcionAdidas.model.Suscripcion;
import com.suscripcionAdidas.model.SuscripcionRest;

@RestController
@RequestMapping(value = "subscription")
public class SuscripcionController {
	@Autowired
	private SuscripcionDAO suscripcionDAO;
	
	
	@PostMapping("/insert")
	public Respuesta alta(@RequestBody SuscripcionRest subscriptionRest) {
		Respuesta res=new Respuesta();
		res.setCodResuesta("ERROR");
		SimpleDateFormat sdf=new SimpleDateFormat("dd/MM/yyyy");
		Suscripcion subscription = new Suscripcion();
		String respuesta="";
		
		respuesta=checkFields(subscriptionRest);
		
		if("Registry inserted".equalsIgnoreCase(respuesta)) { 
			subscription.setEmail(subscriptionRest.getEmail());
			subscription.setFirst_name(subscriptionRest.getFirst_name());
			subscription.setGender(subscriptionRest.getGender());		
			try{
				subscription.setDate_of_birth(sdf.parse(subscriptionRest.getDate_of_birth()));			
			}catch(Exception e) {
				//it will never happen
			}
			subscription.setConsent_flag(subscriptionRest.getConsent_flag().charAt(0));
			subscription.setNewsletter_id(subscriptionRest.getNewsletter_id());
			
			if(suscripcionDAO.existsById(subscription.getDni())) {
				respuesta="El usuario "+subscription.getDni()+" ya esta suscrito";
			}else {
				suscripcionDAO.save(subscription);
				res.setCodResuesta("OK");
			}
		}
		res.setMsjRespuesta(respuesta);
		return res;
	}
	
	@DeleteMapping("/baja/{item}")
	public Respuesta baja(@PathVariable("item") String item) {
		Respuesta res=new Respuesta();
		if(item.length()>9) {
			res.setCodResuesta("ERROR");
			res.setMsjRespuesta("Compruebe la longitud del DNI");
		}else {
			try {
				if(suscripcionDAO.existsById(item)) {
					suscripcionDAO.deleteById(item);
					res.setCodResuesta("OK");
					res.setMsjRespuesta("Se ha dado de baja al usuario "+item);
				}else {
					res.setCodResuesta("ERROR");
					res.setMsjRespuesta("El usuario "+item+" no esta suscrito");
				}
			}catch(Exception e) {
				res.setCodResuesta("ERROR");
				res.setMsjRespuesta("Error al acceder a la base de datos");
			}
		}
		return res;
	}
	
	@GetMapping("/listar/{item}")
	public SuscripcionRest listar(@PathVariable("item") String item){
		SimpleDateFormat sdf=new SimpleDateFormat("dd/MM/yyyy");
		
		if(suscripcionDAO.existsById(item)) {
			Optional<Suscripcion> optSus= suscripcionDAO.findById(item);
			Suscripcion suscripcion=optSus.get();
			
			SuscripcionRest susRest = new SuscripcionRest();
			susRest.setDni(suscripcion.getDni());
			susRest.setNombre(suscripcion.getNombre());
			susRest.setApellido(suscripcion.getApellido());
			if(suscripcion.getFecha_fin()!=null)
				susRest.setFecha_fin(sdf.format(suscripcion.getFecha_fin()));
			
			return susRest;
		}	
		return null;
	}
	
	@GetMapping("/listar")
	public List<SuscripcionRest> listar(){
		SimpleDateFormat sdf=new SimpleDateFormat("dd/MM/yyyy");
		List<SuscripcionRest> suscripcionesRest = new ArrayList<SuscripcionRest>();
		
		List<Suscripcion> suscripciones= suscripcionDAO.findAll();
		for (Suscripcion suscripcion: suscripciones) {
			SuscripcionRest susRest = new SuscripcionRest();
			susRest.setDni(suscripcion.getDni());
			susRest.setNombre(suscripcion.getNombre());
			susRest.setApellido(suscripcion.getApellido());
			if(suscripcion.getFecha_fin()!=null)
				susRest.setFecha_fin(sdf.format(suscripcion.getFecha_fin()));
			
			suscripcionesRest.add(susRest);
		}
		return suscripcionesRest;
	}

	
	private String checkFields(SuscripcionRest subscriptionRest) {
		String respuesta="Registry inserted";
		SimpleDateFormat sdf=new SimpleDateFormat("dd/MM/yyyy");
		//email
		if(subscriptionRest.getEmail()==null || "".equals(subscriptionRest.getEmail().trim())) {
			respuesta="Email not supplied";
		}else if(subscriptionRest.getEmail().trim().length()>255) {
			respuesta="Check the email length";
		}
		//nombre
		if(subscriptionRest.getFirst_name()!=null && subscriptionRest.getFirst_name().trim().length()>255) {
			respuesta="Check the first name length";
		}
		//genero
		if(subscriptionRest.getGender()!=null && subscriptionRest.getGender().trim().length()>255) {
			respuesta="Check the gender length";
		}
		//fecha_nacimiento
		if(subscriptionRest.getDate_of_birth()==null || "".equals(subscriptionRest.getDate_of_birth().trim())) {
			respuesta="Date of birth not supplied";
		}else{
			try {			
				sdf.parse(subscriptionRest.getDate_of_birth());
				String[] partes=subscriptionRest.getDate_of_birth().trim().split("/");
				if(partes[0].length()>2 || partes[1].length()>2 || partes[2].length()!=4)
					respuesta="Check date of birth format (dd/MM/yyyy)";
			}catch(Exception e) {
				respuesta="Check date of birth format (dd/MM/yyyy)";
			}			
		}
		//consent flag
		if(subscriptionRest.getConsent_flag()==null || "".equals(subscriptionRest.getConsent_flag().trim())) {
			respuesta="Consent flag not supplied";
		}else if(subscriptionRest.getConsent_flag().trim().length()>1) {
			respuesta="Check the consent flag length. Should be 1 character";
		}
		//newsletter id
		if(subscriptionRest.getNewsletter_id()==null || "".equals(subscriptionRest.getNewsletter_id().trim())) {
			respuesta="Newsletter id not supplied";
		}else if(subscriptionRest.getNewsletter_id().trim().length()>255) {
			respuesta="Check the newsletter id length";
		}
		return respuesta;
	}
}
